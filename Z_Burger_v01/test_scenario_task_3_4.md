# Task 3.4: updateSetItem 함수 통합 테스트 시나리오

## 목표
사용자가 세트 메뉴를 주문한 후 구성품을 변경하는 대화형 프로세스를 검증합니다.

---

## 시나리오 1: 단일 세트 구성품 자동 교체

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 메뉴 추가 확인
3. 고객: "포테이토를 양념감자 칠리로 바꿔주세요"
4. 봇: 자동으로 세트 감지 및 교체, 추가 금액 안내

### 예상 응답
```
포테이토를 양념감자 (칠리)로 교체했습니다. (추가 500원)

변경된 세트 구성:
- 한우불고기버거 (9,000원)
- 양념감자 (칠리) (2,500원)
- 콜라 (미디움) (2,000원)

세트 총액: 13,500원
```

### 검증 포인트
- ✅ updateSetItem 함수가 set_group_id 없이 호출됨
- ✅ 1개 세트만 있어서 자동 선택됨
- ✅ Cart 테이블에서 B00001 → B00002로 업데이트됨
- ✅ line_total이 정확하게 재계산됨
- ✅ 가격 차이가 명확히 안내됨

---

## 시나리오 2: 여러 세트 중 수동 선택

### 사용자 행동
1. 고객: "한우불고기버거 세트 2개 주세요"
2. 봇: 세트 메뉴 2개 추가 확인
3. 고객: "포테이토를 콘샐러드로 바꿔주세요"
4. 봇: 여러 세트가 있어서 선택 요청

### 예상 응답 (첫 번째)
```
2개의 한우불고기버거 세트가 있습니다.
어떤 세트를 변경하시겠습니까?

1. 한우불고기버거 세트 (주문 시각: 14:30:15)
   - 한우불고기버거, 포테이토, 콜라

2. 한우불고기버거 세트 (주문 시각: 14:30:20)
   - 한우불고기버거, 포테이토, 콜라
```

### 사용자 후속 행동
5. 고객: "첫 번째 세트요"
6. 봇: set_group_id를 지정하여 updateSetItem 재호출

### 예상 응답 (두 번째)
```
첫 번째 세트의 포테이토를 콘샐러드로 교체했습니다. (할인 100원)

변경된 세트 구성:
- 한우불고기버거 (9,000원)
- 콘샐러드 (1,900원)
- 콜라 (미디움) (2,000원)

세트 총액: 12,900원
```

### 검증 포인트
- ✅ updateSetItem이 MULTIPLE_SETS 상태 반환
- ✅ sets 리스트에 2개 세트 정보 포함
- ✅ 사용자 선택 후 set_group_id 지정하여 재호출
- ✅ 특정 세트만 업데이트되고 다른 세트는 유지됨

---

## 시나리오 3: 가격이 낮아지는 교체

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 메뉴 추가
3. 고객: "포테이토를 콘샐러드로 바꿔주세요"
4. 봇: 교체 확인 및 할인 안내

### 예상 응답
```
포테이토를 콘샐러드로 교체했습니다. (할인 100원)

변경된 세트:
- 한우불고기버거 (9,000원)
- 콘샐러드 (1,900원)
- 콜라 (미디움) (2,000원)

세트 총액: 12,900원
```

### 검증 포인트
- ✅ price_difference가 음수(-100)임
- ✅ 메시지에 "할인" 표시됨
- ✅ 장바구니 총액이 정확하게 감소함

---

## 시나리오 4: 여러 번 연속 교체

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 추가
3. 고객: "포테이토를 양념감자 칠리로 바꿔주세요"
4. 봇: 교체 완료 (세트: 버거, 양념감자 칠리, 콜라)
5. 고객: "콜라를 제로슈거콜라로 바꿔주세요"
6. 봇: 교체 완료 (세트: 버거, 양념감자 칠리, 제로슈거콜라)

### 예상 응답 (두 번째 교체)
```
콜라 (미디움)를 제로슈거콜라 (미디움)로 교체했습니다.

최종 세트 구성:
- 한우불고기버거 (9,000원)
- 양념감자 (칠리) (2,500원)
- 제로슈거콜라 (미디움) (2,000원)

세트 총액: 13,500원
```

### 검증 포인트
- ✅ 동일 세트에서 여러 번 교체 가능
- ✅ 각 교체마다 정확한 가격 계산
- ✅ set_group_id는 변경되지 않음

---

## 시나리오 5: 존재하지 않는 상품으로 교체 시도

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 추가
3. 고객: "포테이토를 초코파이로 바꿔주세요"
4. 봇: 상품을 찾을 수 없다는 오류 메시지

### 예상 응답
```
죄송합니다. "초코파이" 상품을 찾을 수 없습니다.
다시 확인해주시겠어요?
```

### 검증 포인트
- ✅ updateSetItem이 ERROR 상태 반환
- ✅ 장바구니가 변경되지 않음
- ✅ 사용자 친화적인 오류 메시지

---

## 시나리오 6: 세트에 없는 구성품 교체 시도

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 추가
3. 고객: "치킨너겟을 포테이토로 바꿔주세요"
4. 봇: 해당 상품이 세트에 없다는 오류 메시지

### 예상 응답
```
죄송합니다. 현재 세트에 "치킨너겟"이 포함되어 있지 않습니다.

현재 세트 구성:
- 한우불고기버거
- 포테이토
- 콜라
```

### 검증 포인트
- ✅ updateSetItem이 ERROR 상태 반환
- ✅ 현재 세트 구성 안내
- ✅ 장바구니 변경되지 않음

---

## 시나리오 7: 다른 종류의 세트 구분

### 사용자 행동
1. 고객: "한우불고기버거 세트와 치즈버거 세트 주세요"
2. 봇: 2개 세트 추가
3. 고객: "한우불고기버거 세트의 포테이토를 양념감자로 바꿔주세요"
4. 봇: 한우불고기버거 세트만 교체

### 예상 응답
```
한우불고기버거 세트의 포테이토를 양념감자 (칠리)로 교체했습니다. (추가 500원)

변경된 세트:
- 한우불고기버거 (9,000원)
- 양념감자 (칠리) (2,500원)
- 콜라 (미디움) (2,000원)

치즈버거 세트는 변경되지 않았습니다:
- 치즈버거 (7,000원)
- 포테이토 (미디움) (2,000원)
- 콜라 (미디움) (2,000원)
```

### 검증 포인트
- ✅ getSetMenusInCart가 세트 종류를 정확히 구분
- ✅ 한우불고기버거 세트(G00001)만 필터링됨
- ✅ 치즈버거 세트는 영향받지 않음

---

## 시나리오 8: 교체 후 주문 완료

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 추가
3. 고객: "포테이토를 양념감자로 바꿔주세요"
4. 봇: 교체 완료
5. 고객: "주문할게요"
6. 봇: 주문 완료

### 예상 응답
```
주문이 완료되었습니다!

주문번호: 42
총 항목: 3개
  - 한우불고기버거 (9,000원)
  - 양념감자 (칠리) (2,500원)
  - 콜라 (미디움) (2,000원)

총 금액: 13,500원
예상 소요 시간: 15분
```

### 검증 포인트
- ✅ 교체된 세트가 Order_Items에 정확히 저장됨
- ✅ set_group_id가 유지되어 세트로 인식됨
- ✅ 총 금액이 교체 후 가격으로 계산됨
- ✅ special_requests 또는 modifications에 변경사항 기록

---

## DB 검증 체크리스트

### Cart 테이블 (교체 중)
- [ ] updateSetItem 호출 시 해당 product_id가 업데이트됨
- [ ] base_price와 line_total이 새 상품 가격으로 변경됨
- [ ] set_group_id는 유지됨
- [ ] 다른 세트 항목들은 영향받지 않음

### getSetMenusInCart 함수
- [ ] 장바구니의 모든 세트 메뉴 조회
- [ ] set_product_id 필터링 정상 작동
- [ ] set_group_id별로 항목 그룹화
- [ ] 각 세트의 set_product_id 정확히 식별
- [ ] created_at 순서로 정렬

### updateSetItem 함수
- [ ] 단일 세트: 자동 선택 및 교체
- [ ] 여러 세트: MULTIPLE_SETS 상태 반환
- [ ] set_group_id 지정 시: 특정 세트만 교체
- [ ] 가격 차이 정확히 계산
- [ ] 적절한 오류 처리 (상품 없음, 세트 없음 등)

---

## 오류 처리 시나리오

### 1. 빈 장바구니에서 교체 시도
- 상황: 장바구니가 비어있음
- 예상 결과: "장바구니에 세트 메뉴가 없습니다"
- updateSetItem 상태: ERROR

### 2. 단품만 있고 세트가 없는 경우
- 상황: 단품 버거만 장바구니에 있음
- 시도: "포테이토를 양념감자로 바꿔주세요"
- 예상 결과: "포테이토가 포함된 세트 메뉴가 없습니다"

### 3. 유효하지 않은 set_group_id
- 상황: 존재하지 않는 set_group_id 지정
- 예상 결과: "세트 그룹 ID를 찾을 수 없습니다"

### 4. DB 연결 오류
- 상황: 데이터베이스 연결 실패
- 예상 결과: 적절한 에러 메시지 및 트랜잭션 롤백

---

## 성공 기준

1. **기능 완성도**
   - ✅ 단일 세트 자동 교체 정상 작동
   - ✅ 여러 세트 중 수동 선택 정상 작동
   - ✅ set_group_id 지정 교체 정상 작동
   - ✅ 가격 차이 정확 계산

2. **데이터 무결성**
   - ✅ Cart 테이블 업데이트 정확성
   - ✅ set_group_id 유지
   - ✅ 다른 항목 영향받지 않음
   - ✅ 가격 계산 정확성

3. **사용자 경험**
   - ✅ 자동/수동 선택 로직의 직관성
   - ✅ 명확한 가격 안내 (추가/할인)
   - ✅ 변경사항 요약 제공
   - ✅ 적절한 오류 메시지

4. **통합성**
   - ✅ getSetMenusInCart와 updateSetItem 연동
   - ✅ addToCart와 호환성
   - ✅ processOrder와 호환성 (교체 후 주문)
   - ✅ LLM 대화 흐름과 자연스러운 연결

---

## 다음 단계 (Task 4.2, 4.3)

### Task 4.2: 오류 처리 및 로깅
- 재고 부족 시 교체 제한
- DB 트랜잭션 실패 시 롤백
- 로그 파일 생성 및 오류 추적

### Task 4.3: 통합 테스트
- 전체 주문 프로세스 E2E 테스트
- 세트 교체 + 주문 완료 시나리오
- 성능 최적화
- 최종 문서화
