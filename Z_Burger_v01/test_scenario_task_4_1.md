# Task 4.1: processOrder 함수 통합 테스트 시나리오

## 목표
사용자가 장바구니에 상품을 담고 실제 주문을 완료하는 전체 프로세스를 검증합니다.

---

## 시나리오 1: 기본 주문 프로세스 (단품)

### 사용자 행동
1. 고객: "한우불고기버거 2개 주세요"
2. 봇: 장바구니에 추가 확인
3. 고객: "콜라 하나 추가요"
4. 봇: 장바구니에 추가 확인
5. 고객: "주문할게요"
6. 봇: 주문 확인 요청
7. 고객: "네, 주문하겠습니다"

### 예상 응답
```
주문이 완료되었습니다!

주문번호: 1
총 항목: 2개
총 금액: 20,000원
예상 소요 시간: 15분

감사합니다!
```

### 검증 포인트
- ✅ Orders 테이블에 주문 레코드 생성됨
- ✅ Order_Items 테이블에 2개 항목 저장됨
- ✅ 장바구니가 비워짐
- ✅ 주문 번호가 자동 증가됨
- ✅ 주문 상태가 'pending'으로 설정됨

---

## 시나리오 2: 세트 메뉴 주문

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 메뉴 추가 확인
3. 고객: "주문하겠습니다"

### 예상 응답
```
주문이 완료되었습니다!

주문번호: 2
총 항목: 3개 (세트 구성품)
  - 한우불고기버거
  - 포테이토 (미디움)
  - 콜라 (미디움)
총 금액: 13,000원
예상 소요 시간: 15분
```

### 검증 포인트
- ✅ Order_Items에 3개 항목이 동일한 set_group_id로 저장됨
- ✅ 세트 할인 가격이 정확하게 계산됨
- ✅ 주문 후 장바구니 비워짐

---

## 시나리오 3: 고객 정보 포함 주문

### 사용자 행동
1. 고객: "한우불고기버거 1개 주세요"
2. 봇: 장바구니에 추가
3. 고객: "배달로 주문할게요"
4. 봇: "고객님 성함과 전화번호를 알려주세요"
5. 고객: "홍길동, 010-1234-5678입니다"
6. 봇: 주문 확인 및 완료

### 예상 응답
```
주문이 완료되었습니다!

주문번호: 3
고객명: 홍길동
연락처: 010-1234-5678
주문 유형: 배달
총 금액: 9,000원
예상 소요 시간: 15분
```

### 검증 포인트
- ✅ Orders 테이블에 customer_name, customer_phone 저장됨
- ✅ order_type이 'delivery'로 설정됨

---

## 시나리오 4: 여러 상품 혼합 주문

### 사용자 행동
1. 고객: "한우불고기버거 2개, 포테이토 1개, 콜라 2개, 그리고 한우불고기버거 세트도 주세요"
2. 봇: 모든 상품 추가 확인
3. 고객: "주문합니다"

### 예상 응답
```
주문이 완료되었습니다!

주문번호: 4
총 항목: 6개
  - 한우불고기버거 x2
  - 포테이토 (미디움) x1
  - 콜라 (미디움) x2
  - 한우불고기버거 세트 (버거, 포테이토, 콜라)
총 금액: 37,000원
```

### 검증 포인트
- ✅ 단품과 세트가 함께 주문됨
- ✅ 총 금액이 정확하게 계산됨
- ✅ Order_Items에 6개 레코드 생성됨

---

## 시나리오 5: 빈 장바구니 주문 시도

### 사용자 행동
1. 고객: "주문할게요"
   (장바구니에 아무것도 없는 상태)

### 예상 응답
```
장바구니가 비어 있습니다.
메뉴를 먼저 선택해주세요!
```

### 검증 포인트
- ✅ 주문이 생성되지 않음
- ✅ 적절한 안내 메시지 표시

---

## 시나리오 6: 주문 번호 자동 증가

### 사용자 행동
1. 첫 번째 고객이 주문 → 주문번호 1
2. 두 번째 고객이 주문 → 주문번호 2
3. 세 번째 고객이 주문 → 주문번호 3

### 예상 결과
- 같은 날 주문 번호가 1부터 순차적으로 증가
- 다음 날이 되면 다시 1부터 시작

### 검증 포인트
- ✅ 주문 번호가 1씩 증가함
- ✅ 날짜별로 주문 번호가 관리됨 (DATE 기준)

---

## 시나리오 7: 옵션 변경된 세트 주문

### 사용자 행동
1. 고객: "한우불고기버거 세트 주세요"
2. 봇: 세트 추가
3. 고객: "포테이토 대신 양념감자(칠리)로 바꿔주세요"
4. 봇: 추가 금액 안내 및 변경
5. 고객: "주문합니다"

### 예상 응답
```
주문이 완료되었습니다!

주문번호: 5
총 항목: 3개
  - 한우불고기버거
  - 양념감자 (칠리) [변경: +600원]
  - 콜라 (미디움)
총 금액: 10,800원
```

### 검증 포인트
- ✅ special_requests 필드에 변경사항 기록됨
- ✅ 추가 금액이 반영됨

---

## 시나리오 8: 주문 완료 후 장바구니 확인

### 사용자 행동
1. 고객: "한우불고기버거 1개 주세요"
2. 봇: 장바구니에 추가
3. 고객: "주문합니다"
4. 봇: 주문 완료
5. 고객: "장바구니 확인해주세요"

### 예상 응답
```
장바구니가 비어 있습니다.
메뉴를 선택해주세요!
```

### 검증 포인트
- ✅ 주문 완료 후 자동으로 장바구니가 비워짐
- ✅ Cart 테이블에서 해당 session_id의 레코드 삭제됨

---

## DB 검증 체크리스트

### Orders 테이블
- [ ] order_id: 고유 ID 생성됨
- [ ] session_id: 주문한 세션 ID
- [ ] total_amount: 장바구니 총액과 일치
- [ ] order_type: 'takeout', 'delivery', 'dine-in' 중 하나
- [ ] customer_name, customer_phone: 입력된 값 저장
- [ ] status: 'pending'으로 초기화
- [ ] estimated_time: 15분으로 설정
- [ ] created_at: 현재 시간 자동 설정

### Order_Items 테이블
- [ ] order_item_id: 고유 ID 생성됨
- [ ] order_id: Orders 테이블의 order_id와 연결
- [ ] 장바구니의 모든 항목이 저장됨
- [ ] set_group_id: 세트 항목은 동일한 ID 공유
- [ ] quantity, base_price, line_total: 장바구니 값과 일치
- [ ] special_requests: 특별 요청사항 저장

### Cart 테이블
- [ ] 주문 완료 후 해당 session_id의 모든 레코드 삭제됨

---

## 오류 처리 시나리오

### 1. 재고 부족 (Sprint 4.2에서 처리 예정)
- 주문 시 재고 확인 필요
- 재고 부족 시 주문 실패 처리

### 2. DB 연결 오류
- 적절한 에러 메시지 반환
- 트랜잭션 롤백 처리

### 3. 중복 주문 방지
- 동일 session_id의 빠른 연속 주문 방지 로직 필요

---

## 성공 기준

1. **기능 완성도**
   - ✅ 모든 주문 정보가 정확하게 DB에 저장됨
   - ✅ 장바구니가 자동으로 비워짐
   - ✅ 주문 번호가 올바르게 증가함

2. **데이터 무결성**
   - ✅ Orders와 Order_Items의 외래키 관계 유지
   - ✅ 총 금액 계산이 정확함
   - ✅ 세트 항목이 set_group_id로 올바르게 그룹화됨

3. **사용자 경험**
   - ✅ 주문 완료 메시지가 명확함
   - ✅ 주문 번호를 통해 주문 추적 가능
   - ✅ 예상 소요 시간 안내

---

## 다음 단계 (Sprint 4.2, 4.3)

### Task 4.2: 오류 처리 및 로깅
- 재고 부족 시 처리
- DB 트랜잭션 실패 시 롤백
- 모든 함수에 try-except 강화
- 로그 파일 생성

### Task 4.3: 통합 테스트
- 전체 주문 프로세스 E2E 테스트
- 버그 수정 및 성능 최적화
- 최종 리뷰 및 문서화
